<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=<device-width>, initial-scale=1.0">
    <title>Stock Data AJAX Call</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <style>
        /* body {
            background: url("Money.jpg");
            background-repeat: no-repeat;
            background-size: cover;
        } */
        
    </style>
</head>
<body>
    <div style="height: 5em; margin-bottom: 1em; background: url(Money.jpg); background-size: cover; background-repeat: no-repeat; align-self: stretch;"></div>
    
    
    
    <div class="form-group" style="margin:auto; width:40em; align-content: center;">
        <h1 style="height: 48px; margin:auto">Stock Information Search</h1>
        <input id="search" class="form-control" type="text" placeholder="Enter Company Symbol">
        <label class="form-label">or select from dropdown</label>
        <select id="company" name="Company" class="form-select" style="width:50%; margin-bottom: 1em;">
            <option value="MSFT">Microsoft</option>
            <option value="BA">Boeing Company</option>
            <option value="AAPL">Apple Inc</option>
            <option value="AMZN">Amazon</option>
            <option value="NVDA">NVIDIA Corporation</option>
        </select>
        <button onclick="getData()" class="btn btn-dark">Search</button>
    </div>

    <!-- <p id="response"></p> -->

    <div div="container" style="width: 40em; margin: auto; margin-top:1em;">
            <table class="table table-striped table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Information</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Stock Symbol</td>
                        <td id="symbol">-</td>
                    </tr>
                    <tr>
                        <td>Date</td>
                        <td id="date">-</td>
                    </tr>
                    <tr>
                        <td>Open Price</td>
                        <td id="open">-</td>
                    </tr>
                    <tr>
                        <td>Daily High Price</td>
                        <td id="high">-</td>
                    </tr>
                    <tr>
                        <td>Daily Low Price</td>
                        <td id="low">-</td>
                    </tr>
                    <tr>
                        <td>Close Price</td>
                        <td id="close">-</td>
                    </tr>
                    <tr>
                        <td>Price Change <img id="changeImage" src=""></td>
                        <td id="change">-</td>
                    </tr>
                </tbody>
            </table>
    </div>
</body>
<script>

    function getData() {
        console.log("Getting Data");
    

        // Step 1
        let xhttp = new XMLHttpRequest();

        // Step 2
    
        xhttp.onreadystatechange = function() { // () => {} wont recognize this, need to use xhttp.readyState...
            // Step 4.5: this all executes succefully with a successfully completed request
            if(this.readyState == 4 && this.status == 200) {
                console.log("Successful Call");

                let stock = JSON.parse(this.responseText);
                console.log(stock);

                // let reply = 
                // "Name: " + character.name + 
                // "<br>Height: " + character.height +
                // "<br>Mass: " + character.mass;

                // `Name: ${character.name} <br>
                // Height: ${character.height} <br>
                // Mass: ${character.mass}`;
                // document.getElementById("response").innerHTML = reply;

                
                let date = stock["Meta Data"]["3. Last Refreshed"];
                let open = stock["Time Series (Daily)"][date]["1. open"];
                let close = stock["Time Series (Daily)"][date]["4. close"];
                document.getElementById("symbol").innerHTML = stock["Meta Data"]["2. Symbol"];
                console.log(stock["Meta Data"]["2. Symbol"]);
                document.getElementById("date").innerHTML = date;
                
                document.getElementById("open").innerHTML = "$" + open;
                document.getElementById("high").innerHTML = "$" + stock["Time Series (Daily)"][date]["2. high"];
                document.getElementById("low").innerHTML = "$" + stock["Time Series (Daily)"][date]["3. low"];
                document.getElementById("close").innerHTML = "$" + close;
                document.getElementById("change").innerHTML = "$" + (parseFloat(close)-parseFloat(open)).toFixed(4);
                // in the black if close is greater than open
                if(close > open) {
                    
                    document.getElementById("changeImage").src = "blackUp.png";
                    document.getElementById("changeImage").style.width = ".8em";
                } else {
                    document.getElementById("changeImage").src = "redDown.jpg";
                    document.getElementById("changeImage").style.width = "2em";
                }
                
            }
        }

        let symbol = document.getElementById('search').value;
        console.log("Symbol: " + symbol);
        symbol = symbol.toUpperCase();
        
        if (symbol == "") {
            company = document.getElementById('company');
            symbol = company.options[company.selectedIndex].value;
        }
        
        let url = "https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=" + symbol +
                    "&apikey=PF406A4969ET26EB"

        // Step 3
        xhttp.open("GET", url , true);

        // Step 4
        xhttp.send();
    
       
    
    }
</script>

</html>